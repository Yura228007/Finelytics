@page "/transactions"
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject NavigationManager Navigation
@inject HttpClient Http

<link href="app.css" rel="stylesheet" />

<div id="transactions-page">
    <h2 id="transactions-title">Записи по плану</h2>

    @* Кнопка для добавления новой транзакции, передавая PlanId *@
    <button @onclick="@(() => RedirectToPage($"add-transaction?id={PlanId}"))" class="btn-add-transaction">Добавить запись</button>

    @* Отображение списка транзакций *@
    @if (transactions == null)
    {
        <p><em>Загрузка записей...</em></p>
    }
    else if (!transactions.Any())
    {
        <p><em>Пока нет записей для этого плана.</em></p>
    }
    else
    {
        <table class="transactions-table">
            <thead>
                <tr>
                    <th>Категория</th>
                    <th>Сумма</th>
                    <th>Комментарий</th>
                    <th>Дата</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in transactions)
                {
                    <tr>
                        <td>@transactionCategories[t.Id]</td>
                        <td>@t.PlannedAmmount</td>
                        <td>@transaction.Comment</td>
                        <td>
                        <button @onclick="@(() => RedirectToPage($"add-transaction?id={Id}&plan_id={PlanId}&transaction_id={t.Id}"))">Редактировать</button>
                        @*<button @onclick="@(() => DeleteTransaction(transaction.Id))">Удалить</button>*@
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "id")]
    public int Id { get; set; } = -1; // Значение по умолчанию, если ID не передан
    
    [Parameter]
    [SupplyParameterFromQuery(Name = "plan_id")]
    public int PlanId { get; set; } = -1; // Значение по умолчанию, если ID не передан

    private List<Transaction>? transactions;

    public Dictionary<int,Category> transactionCategories = new Dictionary<int,Category>

    // Метод для перенаправления на другую страницу
    void RedirectToPage(string url)
    {
        Navigation.NavigateTo(url);
    }

    // Метод для получения имени категории по ее ID
    private string GetCategoryName(int categoryId)
    {
        if (categories == null)
        {
            return "Загрузка..."; // Или "Неизвестно"
        }
        var category = categories.FirstOrDefault(c => c.Id == categoryId);
        return category?.Name ?? "Без категории"; // Возвращаем имя или "Без категории", если не найдено
    }

    protected override async Task OnParametersSetAsync()
    {
        List<Transaction> trans = await Http.GetFromJsonAsync<Transaction>("api/transactions");    
        categories = await Http.GetFromJsonAsync<Category>("api/categories");
        foreach(Transaction t in trans)
        {
            if(t.PlanId == PlanId)
            {
                transactions.Add(t);
            }
        }
        foreach(Transaction t in trans)
        {
            foreach(Categories c in categories)
            {
                if(t.CategoryId == c.Id)
                {
                    transactionCategories.Add(t.Id,c);
                }
            }
        }
    }
}
