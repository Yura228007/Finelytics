@page "/group-plan" // Принимает ID группы
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject NavigationManager Navigation
@inject HttpClient Http

<link href="app.css" rel="stylesheet" />
<div id="group-plans-page">
    <header class="page-header">
        <button @onclick="@(() => RedirectToPage($"groups?user_id={Id}&group_id={GroupId}"))" class="btn-back">← Назад</button>
		<button @onclick="@(() => RedirectToPage($"create-plan?user_id={Id}&group_get={true}"))" id="create-plan-btn" class="btn-primary switch-page-link">Создать план</button>
        <h1>План группы: </h1>
    </header>

    <main class="dashboard-content">
        <h2>Планы этой группы</h2>
        <div class="plans-table-container">
            <table id="plans-table">
                <thead>
                    <tr>
                        <th>Название плана</th>
                        <th>Срок</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
				<tbody>
					@foreach (Plan p in plans)
					{
						<tr class="plan-row" data-plan-id="@p.Id">
							<td class="plan-title">@p.Name</td>
							<td class="plan-date-range">@p.StartDate.ToString("dd.mm.yyyy") - @p.EndDate.ToString("dd.mm.yyyy")</td>
							<td class="plan-status">@GetStringFormEnablePlan(p)</td>
							<td class="plan-actions">
								<button @onclick="@(() => RedirectToPage($"edit-plan?user_id={Id}&plan_id={p.Id}&group_get={true}"))" class="btn-edit" data-plan-id="1">Редактировать</button>
								<button @onclick="@(() => RedirectToPage($"plan-categories?user_id={Id}&plan_id={p.Id}"))" class="btn-details" data-plan-id="1">Категории</button>
								<button @onclick="@(() => RedirectToPage($"transactions?user_id={Id}&plan_id={p.Id}"))" class="btn-details">Транзакции</button>
								<button @onclick="@(() => DeletePlan(p.Id))" class="btn-close-plan" data-plan-id="1">Закрыть план</button>
							</td>
						</tr>
					}
				</tbody>
            </table>
        </div>
    </main>
</div>

@code {
	[Parameter]
	[SupplyParameterFromQuery(Name = "user_id")]
	public int Id { get; set; } = -1;

	[Parameter]
	[SupplyParameterFromQuery(Name = "del_id")]
	public int? DeletePlanId { get; set; } = null;

	[Parameter]
	[SupplyParameterFromQuery(Name = "action")]
	public string? Action { get; set; }

	[Parameter]
	[SupplyParameterFromQuery(Name = "group_id")]
	public int GroupId { get; set; } = -1;

	public List<Plan> plans { get; set; } = new List<Plan>();
	public bool isInitialized { get; set; } = false;
	public bool isProcess { get; set; } = false;
	void RedirectToPage(string url)
	{
		Navigation.NavigateTo(url);
	}
	protected override void OnInitialized()
	{
		isInitialized = true;
	}
	protected override async Task OnParametersSetAsync()
	{
		if (isProcess) return;
		if (Action != null)
		{
			var action = Action;
			Action = null;
			await Process(action);
		}
		else
		{
			await LoadGroupPlans();
		}
	}
	public async Task Process(string action)
	{
		isProcess = true;
		switch (action)
		{
			case "create":
				if (PlansService.CurrentPlan != null)
				{
					await Http.PostAsJsonAsync<Plan>("api/plans", PlansService.CurrentPlan);
					List<Plan> pls = await Http.GetFromJsonAsync<List<Plan>>("api/plans");
					GroupPlans groupPlans = new();
					groupPlans.GroupId = GroupId;
					groupPlans.PlanId = pls.Last().Id;
					await Http.PostAsJsonAsync<GroupPlans>("api/groupplans", groupPlans);
					PlansService.CurrentPlan = null;
					await LoadGroupPlans();
				}
				break;
			case "delete":
				await Http.DeleteAsync($"/api/plans/{DeletePlanId}");
				await LoadGroupPlans();
				break;
			case "edit":
				if (PlansService.CurrentPlan != null)
				{
					await Http.PutAsJsonAsync<Plan>($"api/plans/{PlansService.CurrentPlan.Id}", PlansService.CurrentPlan);
					PlansService.CurrentPlan = null;
					await LoadGroupPlans();
				}
				break;
		}
		ClearProcessParams();
		isProcess = false;
	}
	public async Task LoadGroupPlans()
	{
		plans.Clear();
		List<Plan> allPlans = await Http.GetFromJsonAsync<List<Plan>>("api/plans");
		List<GroupPlans> allGroupsPlans = await Http.GetFromJsonAsync<List<GroupPlans>>("api/groupplans");
		if(allGroupsPlans.Count > 0)
		{
			List<int> allGroupsPlansId = allGroupsPlans.Where(gp => gp.GroupId == GroupId).Select(gp => gp.PlanId).ToList();
			plans.AddRange(allPlans.Where(p => allGroupsPlansId.Contains(p.Id)));
		}
	}

	public void DeletePlan(int id)
	{
		plans.Remove(plans.ElementAt(id - 1));// ElementAt(Id-1)
		Navigation.NavigateTo($"group-plan?user_id={Id}&group_id={GroupId}&del_id={id}&action=delete");
	}
	public void ClearProcessParams()
	{
		Action = null;
		DeletePlanId = null;
		Navigation.NavigateTo($"group-plan?user_id={Id}&group_id={GroupId}", replace: true);
	}
	public string GetStringFormEnablePlan(Plan plan)
	{
		if (plan.IsEnable)
		{
			return "???????";
		}
		else
		{
			return "?????????";
		}
	}
}
